{"CLs":[{"__type":"IST","EID":"cfecbd1d-9398-43de-8c56-7a4337d92744","H":130,"TXT":"\/\/ Initial settings for tests\u000d\u000aSetNoDelayOnOff := FALSE;\u000d\u000asetRcvSize := UINT#1999;","W":400}],"LRI":1,"RRI":2,"VLs":[]}
{"CLs":[{"__type":"LD","Var":"P_On"},{"__type":"IST","EID":"81c874fe-1708-4115-a5a1-dfc3a5748ddb","H":810.66666666666652,"Ix":1,"TXT":"\/\/TCP Status loop\u000d\u000a(*\u000d\u000a\u0009TODO:\u000d\u000a\u0009\u0009Maybe some delay between loops? reduce CPU load\u000d\u000a*)\u000d\u000a\u000d\u000aCASE tcpStatusLoop OF\u000d\u000a    0 : \u000d\u000a\u0009\u0009getTCPStatus := FALSE;\u000d\u000a\u0009\u0009IF Enable  THEN\u000d\u000a\u0009\u0009\u0009tcpStatusLoop :=5;\u000d\u000a\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u000d\u000a\u00095: \u000d\u000a\u0009\u0009IF NOT  InstGetTCPStatus.Busy THEN\u000d\u000a\u0009\u0009\u0009tcpStatusLoop := 10;\u000d\u000a\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u000d\u000a\u000910:\u000d\u000a\u0009\u0009getTCPStatus := TRUE;\u000d\u000a\u0009\u0009tcpStatusLoop := 15;\u000d\u000a\u0009\u0009\u000d\u000a\u000915: \u000d\u000a\u0009\u0009IF InstGetTCPStatus.Done THEN\u000d\u000a\u0009\u0009\u0009tcpStatusLoop := 0;\u000d\u000a\u0009\u0009ELSIF InstGetTCPStatus.Error THEN\u000d\u000a\u0009\u0009\u0009tcpStatusLoop := 0;\u000d\u000a\u0009\u0009\u0009\u000d\u000a\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u000d\u000a\u000920: \/\/ error\u000d\u000a\u0009\u0009Error:= TRUE;\u000d\u000a\u0009\u0009getTCPStatus := FALSE;\u000d\u000a\u0009\u0009IF NOT Enable THEN\u000d\u000a\u0009\u0009\u0009tcpStatusLoop:= 0;\u000d\u000a\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\/\/Add error code\u000d\u000a\u0009\u0009\u000d\u000a\u0009\u0009\u000d\u000a\u0009\u0009\u0009\u000d\u000aELSE\u000d\u000a   tcpStatusLoop := 0; \u000d\u000aEND_CASE;","W":1029.3333333333333,"X":1}],"CMT":"Loop To read Status","LRI":2,"RRI":3,"VLs":[]}
{"CLs":[{"__type":"LD","Var":"P_On"},{"__type":"IST","EID":"d637f47b-97d9-40b9-9b8b-b4935e0b1de4","H":680,"Ix":1,"TXT":"CASE setConnState OF\u000d\u000a    WAIT_ENABLE:\u000d\u000a\u0009\u0009\/\/ Init all to false; Send is controller out of FB\u000d\u000a\u0009\u0009setEnableClient \u0009\u0009\u0009:= FALSE;\u000d\u000a\u0009\u0009setCloseClient\u0009 \u0009\u0009\u0009:= FALSE;\u000d\u000a\u0009\u0009setClearBuffer \u0009\u0009\u0009\u0009:= FALSE;\u000d\u000a\u0009\u0009setSktTCP_NODELAY \u0009:= FALSE;\u000d\u000a\u0009\u0009setRcvData\u0009\u0009\u0009\u0009\u0009:= FALSE;\u000d\u000a\u0009\u0009RcvDataDone\u0009\u0009\u0009:=FALSE;\u000d\u000a\u0009\u0009Connected :=FALSE;\u000d\u000a\u0009\u0009Error := FALSE;\u000d\u000a\u0009\u0009\u000d\u000a\u0009\u0009\/\/Conditions to enable Cleint\u000d\u000a\u0009\u0009\/\/Fix conditions\u000d\u000a\u0009\u0009IF Enable AND PortConnected AND setDstAdr<>'' AND setDstTcpPort>0  THEN\u000d\u000a\u0009\u0009\u0009setConnState\u0009:=\u0009ENABLE_CLIENT;\u000d\u000a\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u000d\u000a\u0009ENABLE_CLIENT :\u000d\u000a\u0009\u0009setEnableClient\u0009:=\u0009TRUE;\u000d\u000a\u0009\u0009IF InstTCPConnect.Busy THEN\u000d\u000a\u0009\u0009\u0009setConnState := WAIT_CONNECTION;\u000d\u000a\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u000d\u000a\u0009WAIT_CONNECTION: \u000d\u000a\u0009\u0009setEnableClient := FALSE;\u000d\u000a\u0009\u0009\u000d\u000a\u0009\u0009\u000d\u000a\u0009\u0009IF getConnectionStatus = _eCONNECTION_STATE#_ESTABLISHED AND Enable AND PortConnected THEN\u000d\u000a\u0009\u0009\u0009\/\/NoDelay Jump after this instead straight to connected\u000d\u000a\u0009\u0009\u0009setConnState := CLIENT_CONNECTED;\u000d\u000a\u0009\u0009ELSIF (NOT Enable OR NOT PortConnected) AND NOT InstTCPConnect.Busy THEN\u000d\u000a\u0009\u0009\u0009setConnState := CLOSE_CONNECTION;\u000d\u000a\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u000d\u000a\u0009CLIENT_CONNECTED:\u000d\u000a\u0009\u0009\u000d\u000a\u0009\u0009IF NOT Enable OR NOT PortConnected OR getConnectionStatus <> _eCONNECTION_STATE#_ESTABLISHED  THEN\u000d\u000a\u0009\u0009\u0009setConnState := CLOSE_CONNECTION;\u000d\u000a\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u000d\u000a\u0009CLOSE_CONNECTION:\u000d\u000a\u0009\u0009setCloseClient := TRUE;\u000d\u000a\u0009\u0009setRcvData := FALSE;\u000d\u000a\u0009\u0009IF InstTCPClose.Done THEN\u000d\u000a\u0009\u0009\u0009setConnState := WAIT_ENABLE;\u000d\u000a\u0009\u0009ELSIF InstTCPClose.Error THEN\u000d\u000a\u0009\u0009\u0009setConnState := WAIT_ENABLE;;\u000d\u000a\u0009\u0009\u0009\u000d\u000a\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u000d\u000a\u0009\u0009\u000d\u000a\u0009\u0009\u000d\u000aELSE\u000d\u000a    setConnState := WAIT_ENABLE;\u000d\u000aEND_CASE;\u000d\u000a\u000d\u000agetSocket := InstTCPConnect.Socket;","W":1002.6666666666669,"X":1}],"CMT":"Connection handle loop\u000d\u000a-Add NoDelay","LRI":2,"RRI":3,"VLs":[]}
{"CLs":[{"__type":"LD","Var":"setEnableClient"},{"__type":"FB","In":[{"__type":"PF","Arg":"Execute"},{"__type":"PRM","Arg":"SrcTcpPort","Ix":1,"Type":"UINT","Var":"setSrcTCPPort"},{"__type":"PRM","Arg":"DstAdr","Ix":2,"Type":"STRING","Var":"setDstAdr"},{"__type":"PRM","Arg":"DstTcpPort","Ix":3,"Type":"UINT","Var":"setDstTcpPort"}],"Ix":8,"Name":"SktTCPConnect","Out":[{"__type":"PF","Arg":"Done"},{"__type":"PRM","Arg":"Busy","Ix":4,"Type":"BOOL","Var":"getAccpetBuys"},{"__type":"PRM","Arg":"Error","Ix":5,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"ErrorID","Ix":6,"Type":"WORD","Var":""},{"__type":"PRM","Arg":"Socket","Ix":7,"Type":"_sSOCKET","Var":""}],"X":1,"Var":"InstTCPConnect"}],"CMT":"TCP Server FB","LRI":9,"RRI":10,"VLs":[]}
{"CLs":[{"__type":"LD","Var":"setCloseClient"},{"__type":"FB","In":[{"__type":"PF","Arg":"Execute"},{"__type":"PRM","Arg":"Socket","Ix":1,"Type":"_sSOCKET","Var":"InstTCPConnect.Socket"}],"Ix":5,"Name":"SktClose","Out":[{"__type":"PF","Arg":"Done"},{"__type":"PRM","Arg":"Busy","Ix":2,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"Error","Ix":3,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"ErrorID","Ix":4,"Type":"WORD","Var":""}],"X":1,"Var":"InstTCPClose"}],"LRI":6,"RRI":7,"VLs":[]}
{"CLs":[{"__type":"LD","Var":"setSktTCP_NODELAY"},{"__type":"FB","In":[{"__type":"PF","Arg":"Execute"},{"__type":"PRM","Arg":"Socket","Ix":1,"Type":"_sSOCKET","Var":"InstTCPConnect.Socket"},{"__type":"PRM","Arg":"OptionType","Ix":2,"Type":"_eSKT_OPTION_TYPE","Var":"_eSKT_OPTION_TYPE#_TCP_NODELAY"},{"__type":"PRM","Arg":"OptionParam","Ix":3,"Type":"ANY","Var":"SetNoDelayOnOff"}],"Ix":7,"Name":"SktSetOption","Out":[{"__type":"PF","Arg":"Done"},{"__type":"PRM","Arg":"Busy","Ix":4,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"Error","Ix":5,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"ErrorID","Ix":6,"Type":"WORD","Var":""}],"X":1,"Var":"InstTCPNoDelay"}],"CMT":"FB to enable NoDelay","LRI":8,"RRI":9,"VLs":[]}
{"CLs":[{"__type":"LD","Var":"setClearBuffer"},{"__type":"FB","In":[{"__type":"PF","Arg":"Execute"},{"__type":"PRM","Arg":"Socket","Ix":1,"Type":"_sSOCKET","Var":"InstTCPConnect.Socket"}],"Ix":5,"Name":"SktClearBuf","Out":[{"__type":"PF","Arg":"Done"},{"__type":"PRM","Arg":"Busy","Ix":2,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"Error","Ix":3,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"ErrorID","Ix":4,"Type":"WORD","Var":""}],"X":1,"Var":"InstClearBuffer"}],"CMT":"Clear Buffer FB","LRI":6,"RRI":7,"VLs":[]}
{"CLs":[{"__type":"LD","Var":"getTCPStatus"},{"__type":"FB","In":[{"__type":"PF","Arg":"Execute"},{"__type":"PRM","Arg":"Socket","Ix":1,"Type":"_sSOCKET","Var":"InstTCPConnect.Socket"}],"Ix":7,"Name":"SktGetTCPStatus","Out":[{"__type":"PF","Arg":"Done"},{"__type":"PRM","Arg":"Busy","Ix":2,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"Error","Ix":3,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"ErrorID","Ix":4,"Type":"WORD","Var":""},{"__type":"PRM","Arg":"TcpStatus","Ix":5,"Type":"_eCONNECTION_STATE","Var":""},{"__type":"PRM","Arg":"DatRcvFlag","Ix":6,"Type":"BOOL","Var":""}],"X":1,"Var":"InstGetTCPStatus"},{"__type":"IST","EID":"826472d3-1b21-4113-b204-e72b8c9f637b","H":240.66666666666663,"Ix":8,"TXT":"IF InstGetTCPStatus.Done then\u000d\u000a\u0009getConnectionStatus \u0009:= InstGetTCPStatus.TcpStatus;\u000d\u000a\u0009getDataRcvFlag \u0009\u0009\u0009:= InstGetTCPStatus.DatRcvFlag;\u000d\u000a\u0009Connected:= getConnectionStatus = _eCONNECTION_STATE#_ESTABLISHED ;\u000d\u000a\u000d\u000a\u0009IF NOT setRcvData AND getDataRcvFlag AND NOT InstGetRcv.Busy THEN\u000d\u000a\u0009\u0009RcvDataDone \u0009:= FALSE;\u000d\u000a\u0009\u0009setRcvData \u0009\u0009:= TRUE;\u000d\u000a\u0009END_IF;\u000d\u000aEND_IF;\u000d\u000a\u0009","W":676,"X":1,"Y":1}],"CMT":"Get connection status ","LRI":9,"RRI":10,"VLs":[{"Ix":11,"X":1}]}
{"CLs":[{"__type":"LD","Var":"Connected"},{"__type":"LD","Id":"5c1e9ed0-e221-4948-8062-8eb60000050d","Ix":1,"Up":true,"Var":"setSend","X":1},{"__type":"FB","In":[{"__type":"PF","Arg":"Execute"},{"__type":"PRM","Arg":"Socket","Ix":2,"Type":"_sSOCKET","Var":"InstTCPConnect.Socket"},{"__type":"PRM","Arg":"SendDat","Ix":3,"Type":"BYTE[]","Var":"setSendData[0]"},{"__type":"PRM","Arg":"Size","Ix":4,"Type":"UINT","Var":"setSendSize"}],"Ix":8,"Name":"SktTCPSend","Out":[{"__type":"PF","Arg":"Done"},{"__type":"PRM","Arg":"Busy","Ix":5,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"Error","Ix":6,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"ErrorID","Ix":7,"Type":"WORD","Var":""}],"X":2,"Var":"InstSetSend"},{"__type":"IST","EID":"fbbbaa2e-107b-428c-be08-65392659e9dd","H":160,"Ix":9,"TXT":"IF InstSetSend.Done THEN\u000d\u000a\u0009SendDone\u0009:=\u0009TRUE;\u000d\u000aELSIF NOT setSend AND SendDone THEN\u000d\u000a\u0009SendDone\u0009:=FALSE;\u000d\u000aEND_IF;","W":661.33333333333337,"X":1,"Y":1},{"__type":"HL","X":2,"Y":1}],"CMT":"Set send data to Client","LRI":10,"RRI":11,"VLs":[{"Ix":12,"X":1}]}
{"CLs":[{"__type":"LD","Ix":1,"Var":"Connected"},{"__type":"LD","Id":"5c1e9ed0-e221-4948-8062-8eb600000686","Up":true,"Var":"setRcvData","X":1},{"__type":"FB","In":[{"__type":"PF","Arg":"Execute"},{"__type":"PRM","Arg":"Socket","Ix":2,"Type":"_sSOCKET","Var":"InstTCPConnect.Socket"},{"__type":"PRM","Arg":"TimeOut","Ix":3,"Type":"UINT","Var":""},{"__type":"PRM","Arg":"Size","Ix":4,"Type":"UINT","Var":"setRcvSize"},{"__type":"PRM","Arg":"RcvDat","IO":true,"Ix":5,"Type":"BYTE[]","Var":"getRcvData[0]"}],"Ix":11,"Name":"SktTCPRcv","Out":[{"__type":"PF","Arg":"Done"},{"__type":"PRM","Arg":"Busy","Ix":6,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"Error","Ix":7,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"ErrorID","Ix":8,"Type":"WORD","Var":""},{"__type":"PRM","Arg":"RcvDat","IO":true,"Ix":9,"Type":"BYTE[]","Var":"getRcvData[0]"},{"__type":"PRM","Arg":"RcvSize","Ix":10,"Type":"UINT","Var":"getRcvSize"}],"X":2,"Var":"InstGetRcv"},{"__type":"IST","EID":"f46f949d-1481-44c2-b718-1a6562c0a432","H":177.99999999999977,"Ix":12,"TXT":"IF InstGetRcv.Done THEN\u000d\u000a\u0009RcvDataDone \u0009:= TRUE;\u000d\u000a\u0009setRcvData\u0009\u0009:= FALSE;\u000d\u000aELSIF InstGetRcv.Busy THEN\u000d\u000a\u0009setRcvData:= FALSE;\u000d\u000aEND_IF;","W":661.33333333333326,"X":1,"Y":1},{"__type":"HL","X":2,"Y":1}],"LRI":13,"RRI":14,"VLs":[{"Ix":15,"X":1}]}
