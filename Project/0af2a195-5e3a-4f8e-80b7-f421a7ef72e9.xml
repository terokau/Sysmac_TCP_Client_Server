{"CLs":[{"__type":"IST","EID":"c98a36da-7c52-4de1-aeb6-3407d174c423","H":130,"TXT":"\/\/ Initial settings for tests\u000d\u000asetTCPAcceptTimeOut := 0;\u000d\u000aSetNoDelayOnOff := FALSE;\u000d\u000asetRcvSize := UINT#1999;","W":400}],"LRI":1,"RRI":2,"VLs":[]}
{"CLs":[{"__type":"LD","Var":"P_On"},{"__type":"IST","EID":"67ab30a2-d602-4364-9fca-39670fd0ee3b","H":635.33333333333348,"Ix":1,"TXT":"\/\/TCP Status loop\u000d\u000a(*\u000d\u000a\u0009TODO:\u000d\u000a\u0009\u0009Maybe some delay between loops? reduce CPU load\u000d\u000a*)\u000d\u000a\u000d\u000aCASE tcpStatusLoop OF\u000d\u000a    0 : \u000d\u000a\u0009\u0009getTCPStatus := FALSE;\u000d\u000a\u0009\u0009tcpStatusLoop :=5;\u000d\u000a\u0009\u0009\u000d\u000a\u00095: \u000d\u000a\u0009\u0009IF NOT  InstGetTCPStatus.Busy THEN\u000d\u000a\u0009\u0009\u0009tcpStatusLoop := 10;\u000d\u000a\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u000d\u000a\u000910:\u000d\u000a\u0009\u0009getTCPStatus := TRUE;\u000d\u000a\u0009\u0009tcpStatusLoop := 15;\u000d\u000a\u0009\u0009\u000d\u000a\u000915: \u000d\u000a\u0009\u0009IF InstGetTCPStatus.Done THEN\u000d\u000a\u0009\u0009\u0009tcpStatusLoop := 0;\u000d\u000a\u0009\u0009ELSIF InstGetTCPStatus.Error THEN\u000d\u000a\u0009\u0009\u0009tcpStatusLoop := 0;\u000d\u000a\u0009\u0009\u0009\u000d\u000a\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u0009\u000d\u000aELSE\u000d\u000a   tcpStatusLoop := 0; \u000d\u000aEND_CASE;","W":687.33333333333337,"X":1}],"CMT":"Loop To read Status","LRI":2,"RRI":3,"VLs":[]}
{"CLs":[{"__type":"LD","Var":"P_On"},{"__type":"IST","EID":"7489d70f-eec3-4377-b544-8cfeb04876bc","H":843.333333333333,"Ix":1,"TXT":"CASE setConnState OF\u000d\u000a    WAIT_ENABLE:\u000d\u000a\u0009\u0009\/\/ Init all to false; Send is controller out of FB\u000d\u000a\u0009\u0009setEnableServer \u0009\u0009\u0009:= FALSE;\u000d\u000a\u0009\u0009setCloseServer\u0009 \u0009\u0009\u0009:= FALSE;\u000d\u000a\u0009\u0009setClearBuffer \u0009\u0009\u0009\u0009:= FALSE;\u000d\u000a\u0009\u0009setSktTCP_NODELAY \u0009:= FALSE;\u000d\u000a\u0009\u0009setRcvData\u0009\u0009\u0009\u0009\u0009:= FALSE;\u000d\u000a\u0009\u0009\u000d\u000a\u0009\u0009\/\/Conditions to enable Server\u000d\u000a\u0009\u0009IF Enable AND PortConnected AND setSrcTCPPort >0  THEN\u000d\u000a\u0009\u0009\u0009setConnState\u0009:=\u0009ENABLE_SERVER;\u000d\u000a\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u000d\u000a\u0009ENABLE_SERVER :\u000d\u000a\u0009\u0009setEnableServer\u0009:=\u0009TRUE;\u000d\u000a\u0009\u0009IF InstTCPAccept.Busy THEN\u000d\u000a\u0009\u0009\u0009setConnState := WAIT_CONNECTION;\u000d\u000a\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u000d\u000a\u0009WAIT_CONNECTION: \u000d\u000a\u0009\u0009setEnableServer := FALSE;\u000d\u000a\u0009\u0009\u000d\u000a\u0009\u0009\u000d\u000a\u0009\u0009IF getConnectionStatus = _eCONNECTION_STATE#_ESTABLISHED THEN\u000d\u000a\u0009\u0009\u0009\/\/NoDelay Jump after this instead straight to connected\u000d\u000a\u0009\u0009\u0009setConnState := CLIENT_CONNECTED;\u000d\u000a\u0009\u0009ELSIF NOT Enable OR NOT PortConnected THEN\u000d\u000a\u0009\u0009\u0009setConnState := CLOSE_CONNECTION;\u000d\u000a\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u000d\u000a\u0009CLIENT_CONNECTED:\u000d\u000a\u0009\u0009\u000d\u000a\u0009\u0009IF NOT Enable OR NOT PortConnected OR getConnectionStatus <> _eCONNECTION_STATE#_ESTABLISHED  THEN\u000d\u000a\u0009\u0009\u0009setConnState := CLOSE_CONNECTION;\u000d\u000a\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u000d\u000a\u0009CLOSE_CONNECTION:\u000d\u000a\u0009\u0009setCloseServer := TRUE;\u000d\u000a\u0009\u0009setRcvData := FALSE;\u000d\u000a\u0009\u0009IF InstTCPClose.Done THEN\u000d\u000a\u0009\u0009\u0009setConnState := WAIT_ENABLE;\u000d\u000a\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u000d\u000a\u0009\u0009\u000d\u000a\u0009\u0009\u000d\u000aELSE\u000d\u000a    setConnState := WAIT_ENABLE;\u000d\u000aEND_CASE;\u000d\u000a\u000d\u000agetSocket := InstTCPAccept.Socket;","W":687.33333333333314,"X":1}],"CMT":"Connection handle loop\u000d\u000a-Add NoDelay","LRI":2,"RRI":3,"VLs":[]}
{"CLs":[{"__type":"LD","Var":"setEnableServer"},{"__type":"FB","In":[{"__type":"PF","Arg":"Execute"},{"__type":"PRM","Arg":"SrcTcpPort","Ix":1,"Type":"UINT","Var":"setSrcTCPPort"},{"__type":"PRM","Arg":"TimeOut","Ix":2,"Type":"UINT","Var":"setTCPAcceptTimeOut"}],"Ix":7,"Name":"SktTCPAccept","Out":[{"__type":"PF","Arg":"Done"},{"__type":"PRM","Arg":"Busy","Ix":3,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"Error","Ix":4,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"ErrorID","Ix":5,"Type":"WORD","Var":""},{"__type":"PRM","Arg":"Socket","Ix":6,"Type":"_sSOCKET","Var":""}],"X":1,"Var":"InstTCPAccept"}],"CMT":"TCP Server FB","LRI":8,"RRI":9,"VLs":[]}
{"CLs":[{"__type":"LD","Var":"setCloseServer"},{"__type":"FB","In":[{"__type":"PF","Arg":"Execute"},{"__type":"PRM","Arg":"Socket","Ix":1,"Type":"_sSOCKET","Var":"InstTCPAccept.Socket"}],"Ix":5,"Name":"SktClose","Out":[{"__type":"PF","Arg":"Done"},{"__type":"PRM","Arg":"Busy","Ix":2,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"Error","Ix":3,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"ErrorID","Ix":4,"Type":"WORD","Var":""}],"X":1,"Var":"InstTCPClose"}],"LRI":6,"RRI":7,"VLs":[]}
{"CLs":[{"__type":"LD","Var":"setSktTCP_NODELAY"},{"__type":"FB","In":[{"__type":"PF","Arg":"Execute"},{"__type":"PRM","Arg":"Socket","Ix":1,"Type":"_sSOCKET","Var":"InstTCPAccept.Socket"},{"__type":"PRM","Arg":"OptionType","Ix":2,"Type":"_eSKT_OPTION_TYPE","Var":"_eSKT_OPTION_TYPE#_TCP_NODELAY"},{"__type":"PRM","Arg":"OptionParam","Ix":3,"Type":"ANY","Var":"SetNoDelayOnOff"}],"Ix":7,"Name":"SktSetOption","Out":[{"__type":"PF","Arg":"Done"},{"__type":"PRM","Arg":"Busy","Ix":4,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"Error","Ix":5,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"ErrorID","Ix":6,"Type":"WORD","Var":""}],"X":1,"Var":"InstTCPNoDelay"}],"CMT":"FB to enable NoDelay","LRI":8,"RRI":9,"VLs":[]}
{"CLs":[{"__type":"LD","Var":"setClearBuffer"},{"__type":"FB","In":[{"__type":"PF","Arg":"Execute"},{"__type":"PRM","Arg":"Socket","Ix":1,"Type":"_sSOCKET","Var":"InstTCPAccept.Socket"}],"Ix":5,"Name":"SktClearBuf","Out":[{"__type":"PF","Arg":"Done"},{"__type":"PRM","Arg":"Busy","Ix":2,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"Error","Ix":3,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"ErrorID","Ix":4,"Type":"WORD","Var":""}],"X":1,"Var":"InstClearBuffer"}],"CMT":"Clear Buffer FB","LRI":6,"RRI":7,"VLs":[]}
{"CLs":[{"__type":"LD","Var":"getTCPStatus"},{"__type":"FB","In":[{"__type":"PF","Arg":"Execute"},{"__type":"PRM","Arg":"Socket","Ix":1,"Type":"_sSOCKET","Var":"InstTCPAccept.Socket"}],"Ix":7,"Name":"SktGetTCPStatus","Out":[{"__type":"PF","Arg":"Done"},{"__type":"PRM","Arg":"Busy","Ix":2,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"Error","Ix":3,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"ErrorID","Ix":4,"Type":"WORD","Var":""},{"__type":"PRM","Arg":"TcpStatus","Ix":5,"Type":"_eCONNECTION_STATE","Var":""},{"__type":"PRM","Arg":"DatRcvFlag","Ix":6,"Type":"BOOL","Var":""}],"X":1,"Var":"InstGetTCPStatus"},{"__type":"IST","EID":"c924e5d5-9bb6-46d0-9267-813362fa4f95","H":266.00000000000034,"Ix":8,"TXT":"getConnectionStatus \u0009:= InstGetTCPStatus.TcpStatus;\u000d\u000agetDataRcvFlag \u0009\u0009\u0009:= InstGetTCPStatus.DatRcvFlag;\u000d\u000aConnected:= getConnectionStatus = _eCONNECTION_STATE#_ESTABLISHED ;\u000d\u000a\u000d\u000aIF NOT setRcvData AND getDataRcvFlag AND NOT InstGetRcv.Busy THEN\u000d\u000a\u0009RcvDataDone \u0009:= FALSE;\u000d\u000a\u0009setRcvData \u0009\u0009:= TRUE;\u000d\u000aEND_IF;\u000d\u000a\u0009","W":793.33333333333326,"X":2}],"CMT":"Get connection status ","LRI":9,"RRI":10,"VLs":[]}
{"CLs":[{"__type":"LD","Var":"Connected"},{"__type":"LD","Id":"0d670352-fc3b-4aea-a029-bb4200000412","Ix":1,"Up":true,"Var":"setSend","X":1},{"__type":"FB","In":[{"__type":"PF","Arg":"Execute"},{"__type":"PRM","Arg":"Socket","Ix":2,"Type":"_sSOCKET","Var":"InstTCPAccept.Socket"},{"__type":"PRM","Arg":"SendDat","Ix":3,"Type":"BYTE[]","Var":"setSendData[0]"},{"__type":"PRM","Arg":"Size","Ix":4,"Type":"UINT","Var":"setSendSize"}],"Ix":8,"Name":"SktTCPSend","Out":[{"__type":"PF","Arg":"Done"},{"__type":"PRM","Arg":"Busy","Ix":5,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"Error","Ix":6,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"ErrorID","Ix":7,"Type":"WORD","Var":""}],"X":2,"Var":"InstSetSend"},{"__type":"IST","EID":"1b9b97af-c825-47ea-8bc2-8d347774f383","H":130,"Ix":9,"TXT":"IF InstSetSend.Done THEN\u000d\u000a\u0009SendDone\u0009:=\u0009TRUE;\u000d\u000aELSIF NOT setSend AND SendDone THEN\u000d\u000a\u0009SendDone\u0009:=FALSE;\u000d\u000aEND_IF;","W":541.33333333333326,"X":1,"Y":1},{"__type":"HL","X":2,"Y":1}],"CMT":"Set send data to Client","LRI":10,"RRI":11,"VLs":[{"Ix":12,"X":1}]}
{"CLs":[{"__type":"LD","Ix":1,"Var":"Connected"},{"__type":"LD","Id":"87d367d0-9fb7-47b3-818a-33deda7d200e","Up":true,"Var":"setRcvData","X":1},{"__type":"FB","In":[{"__type":"PF","Arg":"Execute"},{"__type":"PRM","Arg":"Socket","Ix":2,"Type":"_sSOCKET","Var":"InstTCPAccept.Socket"},{"__type":"PRM","Arg":"TimeOut","Ix":3,"Type":"UINT","Var":""},{"__type":"PRM","Arg":"Size","Ix":4,"Type":"UINT","Var":"setRcvSize"},{"__type":"PRM","Arg":"RcvDat","IO":true,"Ix":5,"Type":"BYTE[]","Var":"getRcvData[0]"}],"Ix":11,"Name":"SktTCPRcv","Out":[{"__type":"PF","Arg":"Done"},{"__type":"PRM","Arg":"Busy","Ix":6,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"Error","Ix":7,"Type":"BOOL","Var":""},{"__type":"PRM","Arg":"ErrorID","Ix":8,"Type":"WORD","Var":""},{"__type":"PRM","Arg":"RcvDat","IO":true,"Ix":9,"Type":"BYTE[]","Var":"getRcvData[0]"},{"__type":"PRM","Arg":"RcvSize","Ix":10,"Type":"UINT","Var":"getRcvSize"}],"X":2,"Var":"InstGetRcv"},{"__type":"IST","EID":"ba1a439d-37e4-4e1e-a8bc-544d82cdc167","H":205.99999999999977,"Ix":12,"TXT":"IF InstGetRcv.Done THEN\u000d\u000a\u0009RcvDataDone \u0009:= TRUE;\u000d\u000a\u0009setRcvData\u0009\u0009:= FALSE;\u000d\u000aELSIF InstGetRcv.Busy THEN\u000d\u000a\u0009setRcvData:= FALSE;\u000d\u000aEND_IF;","W":526.66666666666674,"X":1,"Y":1},{"__type":"HL","X":2,"Y":1}],"LRI":13,"RRI":14,"VLs":[{"Ix":15,"X":1}]}
